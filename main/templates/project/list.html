{% extends "layouts/master_sidebar.html" %}

{% comment %}
ATTENTION FOR THE SCRIPT: you must include the divs with the id "data" and "object-name" in order to make the script
work. The first one must contain the data in json format and the second one must contain the name of the object to be
displayed in the preview text (e.g. "donación")
{% endcomment %}

{% load static %}

{% block extrahead %}
  <link rel="stylesheet" type="text/css" href="{% static 'styles/projects.css' %}">
{% endblock %}

{% block botonPrimario %}
<a  href="/project/create">
{% include 'components/button.html' with variation='PLUS' text='Añadir '|add:object_name|safe %}</a>
{% endblock %}

{% block objectFor %}
<form method="GET" class="mb-4">
  {% csrf_token %}
  {{form}}
  <input type="submit" value="Filtrar">
  <button type="reset" class="btn btn-secondary">Borrar filtros</button>
</form>

<!-- TABLE HEADER -->
<div id="id-tableHeader" class="container-fluid">
  <div class="row">
    <div class="col-6"><strong>T&iacute;tulo</strong></div>
    <div class="col-3"><strong>Pa&iacute;s</strong></div>
    <div class="col-3"><strong>Fecha de inicio</strong></div>
  </div>
  <hr class="my-1">
</div>

{% for object in objects %}

<div class="container-fluid mw-100 px-2 card-list rounded py-1" tabindex="1">
  <span class="object-id d-none">{{ object.id }}</span>
    <div class="row">

      <div class="col-6">
        <strong><h5 title="{{object.title}}">{{object.title}}</h5></strong>
      </div>

      <div class="col-3">
        <span>{{object.country}}</span>
      </div> 

      <div class="col-3">
        <span>{{object.start_date}}</span>
      </div> 
        
    </div>

    <div class="d-none d-flex flex-column " id="moreInfo">
      <span class="object-description pt-1"><strong>Pa&iacute;s:&nbsp;</strong>{{ object.country }}</span>
      <span class="object-donor-name pt-1"><strong>Fecha de inicio:&nbsp;</strong>{{ object.start_date  }}</span>
      <span class="object-donor-dni pt-1"><strong>Fecha de fin:&nbsp;</strong>{{ object.end_date  }}</span>
      <span class="object-donor-address pt-1"><strong>N&uacute;mero de beneficiarios:&nbsp;</strong>{{ object.number_of_beneficiaries  }}</span>
      <span class="object-donor-email pt-1"><strong>Cantiad:&nbsp;</strong>{{ object.amount  }}&euro;</span>
      <span class="object-donor-email pt-1"><strong>Fecha de anuncio:&nbsp;</strong>{{ object.announcement_date  }}</span>

      <div class="container mt-2 border-dark border-top border-1  p-0">
        <div class="row d-flex flex-column text-center p-2" id="lateralButtons">
          <a href="${ objectData.id }/update"><i class="bi bi-pencil"></i>Editar</a>
          <a href="${ objectData.id }/delete"><i class="bi bi-x"></i>Eliminar</a>
        </div>
      </div>
    </div>
    
</div>
{% endfor %}

<div class="pagination">
  <span class="step-links">
    {% if objects.has_previous %}
    <a href="?page=1{% if request.GET.title %}&title={{ request.GET.title }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}{% if request.GET.start_date_min %}&start_date_min={{ request.GET.start_date_min }}{% endif %}
    {% if request.GET.start_date_max %}&start_date_max={{ request.GET.start_date_max }}{% endif %}{% if request.GET.end_date_min %}&end_date_min={{ request.GET.end_date_min }}{% endif %}{% if request.GET.end_date_max %}&end_date_max={{ request.GET.end_date_max }}{% endif %}
    {% if request.GET.number_of_beneficiaries_min %}&number_of_beneficiaries_min={{ request.GET.number_of_beneficiaries_min }}{% endif %}{% if request.GET.number_of_beneficiaries_max %}&number_of_beneficiaries_max={{ request.GET.number_of_beneficiaries_max }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}
    {% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.announcement_date_min %}&announcement_date_min={{ request.GET.announcement_date_min }}{% endif %}{% if request.GET.announcement_date_max %}&announcement_date_max={{ request.GET.announcement_date_max }}{% endif %}">&laquo; Primera</a>
    <a href="?page={{ objects.previous_page_number }}{% if request.GET.title %}&title={{ request.GET.title }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}{% if request.GET.start_date_min %}&start_date_min={{ request.GET.start_date_min }}{% endif %}
    {% if request.GET.start_date_max %}&start_date_max={{ request.GET.start_date_max }}{% endif %}{% if request.GET.end_date_min %}&end_date_min={{ request.GET.end_date_min }}{% endif %}{% if request.GET.end_date_max %}&end_date_max={{ request.GET.end_date_max }}{% endif %}
    {% if request.GET.number_of_beneficiaries_min %}&number_of_beneficiaries_min={{ request.GET.number_of_beneficiaries_min }}{% endif %}{% if request.GET.number_of_beneficiaries_max %}&number_of_beneficiaries_max={{ request.GET.number_of_beneficiaries_max }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}
    {% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.announcement_date_min %}&announcement_date_min={{ request.GET.announcement_date_min }}{% endif %}{% if request.GET.announcement_date_max %}&announcement_date_max={{ request.GET.announcement_date_max }}{% endif %}">Anterior</a>
{% endif %}

<span class="current">
  Página {{ objects.number }} de {{ objects.paginator.num_pages }}.
</span>

{% if objects.has_next %}
    <a href="?page={{ objects.next_page_number }}{% if request.GET.title %}&title={{ request.GET.title }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}{% if request.GET.start_date_min %}&start_date_min={{ request.GET.start_date_min }}{% endif %}
    {% if request.GET.start_date_max %}&start_date_max={{ request.GET.start_date_max }}{% endif %}{% if request.GET.end_date_min %}&end_date_min={{ request.GET.end_date_min }}{% endif %}{% if request.GET.end_date_max %}&end_date_max={{ request.GET.end_date_max }}{% endif %}
    {% if request.GET.number_of_beneficiaries_min %}&number_of_beneficiaries_min={{ request.GET.number_of_beneficiaries_min }}{% endif %}{% if request.GET.number_of_beneficiaries_max %}&number_of_beneficiaries_max={{ request.GET.number_of_beneficiaries_max }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}
    {% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.announcement_date_min %}&announcement_date_min={{ request.GET.announcement_date_min }}{% endif %}{% if request.GET.announcement_date_max %}&announcement_date_max={{ request.GET.announcement_date_max }}{% endif %}">Siguiente</a>
    <a href="?page={{ objects.paginator.num_pages }}{% if request.GET.title %}&title={{ request.GET.title }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}{% if request.GET.start_date_min %}&start_date_min={{ request.GET.start_date_min }}{% endif %}
    {% if request.GET.start_date_max %}&start_date_max={{ request.GET.start_date_max }}{% endif %}{% if request.GET.end_date_min %}&end_date_min={{ request.GET.end_date_min }}{% endif %}{% if request.GET.end_date_max %}&end_date_max={{ request.GET.end_date_max }}{% endif %}
    {% if request.GET.number_of_beneficiaries_min %}&number_of_beneficiaries_min={{ request.GET.number_of_beneficiaries_min }}{% endif %}{% if request.GET.number_of_beneficiaries_max %}&number_of_beneficiaries_max={{ request.GET.number_of_beneficiaries_max }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}
    {% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.announcement_date_min %}&announcement_date_min={{ request.GET.announcement_date_min }}{% endif %}{% if request.GET.announcement_date_max %}&announcement_date_max={{ request.GET.announcement_date_max }}{% endif %}">Última &raquo;</a>
{% endif %}
  </span>
</div>

<div id="data" data-json='{{ objects_json|safe }}'></div>
<div id="object-name" data-name='{{ object_name }}'></div>

{% endblock %}


{% block scripts %}
<script id="object-data">
  const objectList = document.querySelectorAll('.card-list')
  const objetos = JSON.parse('{{ objects_json|escapejs }}')
  const preview = document.querySelector('#preview')
  const prevInfo = document.querySelector('#prev-info')

  objectList.forEach(object => {
    const moreInfo = object.querySelector('#moreInfo')
    object.addEventListener('click', () => {
      const isMobile = window.matchMedia("(max-width: 768px)").matches
      const isExpanded = !moreInfo.classList.contains('d-none')
      const objectId = object.querySelector('.object-id').innerText
      
      const objectData = objetos.find(object => object.id == objectId)

      if (isMobile) {
        if (isExpanded) {
          moreInfo.classList.add('d-none')
        } else {
          moreInfo.classList.remove('d-none')
        }

  } else {

        prevInfo.classList.add('d-none')
        preview.classList.remove('text-center')
          preview.innerHTML = `
        <div class="row ">
          <div class="col-12  px-4">
            
            <h2 title="${objectData.title ? objectData.title : 'No especificado' }">${objectData.title ? objectData.title : 'No especificado' }</h2>
            <h5>{{object_name}}</h5>
            <p><strong>Pa&iacute;s:&nbsp;</strong>${objectData.country ? objectData.country : 'No especificado' }</p>
            <p><strong>Fecha de inicio:&nbsp;</strong>${objectData.start_date ? objectData.start_date : 'No especificado'}</p>
            <p><strong>Fecha de fin:&nbsp;</strong>${objectData.end_date ? objectData.end_date : 'No especificado'}</p>
            <p><strong>N&uacute;mero de beneficiarios:&nbsp;</strong>${objectData.number_of_beneficiaries ? objectData.number_of_beneficiaries : 'No especificado'}</p>
            <p><strong>Cantidad:&nbsp;</strong>${objectData.amount ? objectData.amount + '€' : 'No especificado'};</p>
            <p><strong>Fecha de anuncio:&nbsp;</strong>${objectData.announcement_date ? objectData.announcement_date : 'No especificado'}</p>
          </div>
        </div>

        <div class="container mt-auto border-dark border-top border-1  p-0">
          <div class="row d-flex flex-column text-center p-3" id="lateralButtons">
            <a href="${ objectData.id }/update"><i class="bi bi-pencil"></i>Editar</a>
            <a href="${ objectData.id }/delete"><i class="bi bi-x"></i>Eliminar</a>
          </div>
        </div>
      `
      }

    })

    // when resizing the window, the preview will be reset
    window.addEventListener('resize', () => {
      moreInfo.classList.add('d-none')
      prevInfo.classList.remove('d-none')
      preview.classList.add('text-center')
      preview.classList.remove('p-5')
      preview.innerHTML = `<span id="prev-info">Pulsa sobre una {{ object_name }} para la vista previa</span>`

    })

  })

</script>

<script>
        document.querySelector('button[type="reset"]').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = window.location.pathname;
        });
    </script>
{% endblock %}
